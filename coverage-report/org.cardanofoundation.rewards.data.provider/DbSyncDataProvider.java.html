<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DbSyncDataProvider.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cardano-reward-calculation</a> &gt; <a href="index.source.html" class="el_package">org.cardanofoundation.rewards.data.provider</a> &gt; <span class="el_source">DbSyncDataProvider.java</span></div><h1>DbSyncDataProvider.java</h1><pre class="source lang-java linenums">package org.cardanofoundation.rewards.data.provider;

import org.cardanofoundation.rewards.calculation.PoolRewardCalculation;
import org.cardanofoundation.rewards.entity.*;
import org.cardanofoundation.rewards.entity.jpa.*;
import org.cardanofoundation.rewards.entity.jpa.projection.PoolEpochStake;
import org.cardanofoundation.rewards.enums.AccountUpdateAction;
import org.cardanofoundation.rewards.enums.MirPot;
import org.cardanofoundation.rewards.mapper.*;
import org.cardanofoundation.rewards.repository.*;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Profile;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;

import static org.cardanofoundation.rewards.constants.RewardConstants.TOTAL_LOVELACE;

@Service
@Profile(&quot;db-sync&quot;)
<span class="fc" id="L22">public class DbSyncDataProvider implements DataProvider {</span>

    @Autowired
    DbSyncEpochRepository dbSyncEpochRepository;
    @Autowired
    DbSyncAdaPotsRepository dbSyncAdaPotsRepository;
    @Autowired
    DbSyncProtocolParametersRepository dbSyncProtocolParametersRepository;
    @Autowired
    DbSyncBlockRepository dbSyncBlockRepository;
    @Autowired
    DbSyncEpochStakeRepository dbSyncEpochStakeRepository;

    @Autowired
    DbSyncPoolUpdateRepository dbSyncPoolUpdateRepository;

    @Autowired
    DbSyncPoolOwnerRepository dbSyncPoolOwnerRepository;

    @Autowired
    DbSyncRewardRepository dbSyncRewardRepository;

    @Autowired
    DbSyncPoolRetirementRepository dbSyncPoolRetirementRepository;

    @Autowired
    DbSyncStakeDeregistrationRepository dbSyncStakeDeregistrationRepository;

    @Autowired
    DbSyncStakeRegistrationRepository dbSyncStakeRegistrationRepository;

    @Autowired
    DbSyncTransactionRepository dbSyncTransactionRepository;

    @Autowired
    DbSyncWithdrawalRepository dbSyncWithdrawalRepository;

    @Override
    public AdaPots getAdaPotsForEpoch(int epoch) {
<span class="nc" id="L61">        DbSyncAdaPots dbSyncAdaPots = dbSyncAdaPotsRepository.findByEpoch(epoch);</span>
<span class="nc" id="L62">        return AdaPotsMapper.fromDbSyncAdaPots(dbSyncAdaPots);</span>
    }

    @Override
    public Epoch getEpochInfo(int epoch) {
<span class="nc" id="L67">        DbSyncEpoch dbSyncEpoch = dbSyncEpochRepository.findByNumber(epoch);</span>
<span class="nc" id="L68">        Epoch epochInfo = EpochMapper.fromDbSyncEpoch(dbSyncEpoch);</span>

<span class="nc bnc" id="L70" title="All 2 branches missed.">        if (epoch &lt; 211) {</span>
<span class="nc" id="L71">            epochInfo.setOBFTBlockCount(epochInfo.getBlockCount());</span>
<span class="nc" id="L72">            epochInfo.setNonOBFTBlockCount(0);</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">        } else if (epoch &gt; 256) {</span>
<span class="nc" id="L74">            epochInfo.setOBFTBlockCount(0);</span>
<span class="nc" id="L75">            epochInfo.setNonOBFTBlockCount(epochInfo.getBlockCount());</span>
        } else {
<span class="nc" id="L77">            Integer nonObftBlocks = dbSyncBlockRepository.getNonOBFTBlocksInEpoch(epoch);</span>
<span class="nc" id="L78">            Integer obftBlocks = dbSyncBlockRepository.getOBFTBlocksInEpoch(epoch);</span>
<span class="nc" id="L79">            epochInfo.setOBFTBlockCount(obftBlocks);</span>
<span class="nc" id="L80">            epochInfo.setNonOBFTBlockCount(nonObftBlocks);</span>
        }

<span class="nc" id="L83">        Long epochStake = dbSyncEpochStakeRepository.getEpochStakeByEpoch(epoch);</span>
<span class="nc" id="L84">        epochInfo.setActiveStake(epochStake.doubleValue());</span>

<span class="nc" id="L86">        return epochInfo;</span>
    }

    @Override
    public ProtocolParameters getProtocolParametersForEpoch(int epoch) {
<span class="nc" id="L91">        DbSyncProtocolParameters dbSyncProtocolParameters = dbSyncProtocolParametersRepository.findByEpoch(epoch);</span>
<span class="nc" id="L92">        return ProtocolParametersMapper.fromDbSyncProtocolParameters(dbSyncProtocolParameters);</span>
    }

    @Override
    public PoolHistory getPoolHistory(String poolId, int epoch) {
<span class="nc" id="L97">        PoolHistory poolHistory = new PoolHistory();</span>
<span class="nc" id="L98">        List&lt;PoolEpochStake&gt; poolEpochStakes = dbSyncEpochStakeRepository.getPoolActiveStakeInEpoch(poolId, epoch);</span>
<span class="nc" id="L99">        double activeStake = 0;</span>
<span class="nc" id="L100">        List&lt;Delegator&gt; delegators = new ArrayList&lt;&gt;();</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">        for (PoolEpochStake poolEpochStake : poolEpochStakes) {</span>
<span class="nc" id="L102">            activeStake += poolEpochStake.getAmount();</span>
<span class="nc" id="L103">            Delegator delegator = Delegator.builder()</span>
<span class="nc" id="L104">                    .stakeAddress(poolEpochStake.getStakeAddress())</span>
<span class="nc" id="L105">                    .activeStake(poolEpochStake.getAmount())</span>
<span class="nc" id="L106">                    .build();</span>
<span class="nc" id="L107">            delegators.add(delegator);</span>
<span class="nc" id="L108">        }</span>

<span class="nc bnc" id="L110" title="All 2 branches missed.">        if (delegators.isEmpty()) {</span>
<span class="nc" id="L111">            return null;</span>
        }

<span class="nc" id="L114">        poolHistory.setActiveStake(activeStake);</span>
<span class="nc" id="L115">        poolHistory.setDelegators(delegators);</span>

<span class="nc" id="L117">        Integer blockCount = dbSyncBlockRepository.getBlocksMadeByPoolInEpoch(poolId, epoch);</span>
<span class="nc" id="L118">        poolHistory.setBlockCount(blockCount);</span>

<span class="nc" id="L120">        DbSyncPoolUpdate dbSyncPoolUpdate = dbSyncPoolUpdateRepository.findLastestUpdateForEpoch(poolId, epoch);</span>
<span class="nc" id="L121">        poolHistory.setFixedCost(dbSyncPoolUpdate.getFixedCost());</span>
<span class="nc" id="L122">        poolHistory.setMargin(dbSyncPoolUpdate.getMargin());</span>
<span class="nc" id="L123">        poolHistory.setEpoch(epoch);</span>

<span class="nc" id="L125">        double totalPoolRewards = dbSyncRewardRepository.getRewardsForPoolInEpoch(poolId, epoch);</span>

<span class="nc" id="L127">        DbSyncAdaPots dbSyncAdaPots = dbSyncAdaPotsRepository.findByEpoch(epoch + 1);</span>
<span class="nc" id="L128">        double reserves = dbSyncAdaPots.getReserves();</span>
<span class="nc" id="L129">        double adaInCirculation = TOTAL_LOVELACE - reserves;</span>
<span class="nc" id="L130">        double relativePoolStake = activeStake / adaInCirculation;</span>

<span class="nc" id="L132">        List&lt;DbSyncPoolOwner&gt; owners = dbSyncPoolOwnerRepository.getByPoolUpdateId(dbSyncPoolUpdate.getId());</span>

<span class="nc" id="L134">        double totalActiveStakeOfOwners = 0.0;</span>
<span class="nc" id="L135">        double totalMemberRewardsOfOwners = 0.0;</span>

<span class="nc bnc" id="L137" title="All 2 branches missed.">        for (DbSyncPoolOwner owner : owners) {</span>
<span class="nc" id="L138">            Delegator delegator = poolHistory.getDelegator(owner.getStakeAddress().getView());</span>
<span class="nc" id="L139">            totalActiveStakeOfOwners += delegator.getActiveStake();</span>
<span class="nc" id="L140">            totalMemberRewardsOfOwners += PoolRewardCalculation.calculateMemberReward(totalPoolRewards,</span>
<span class="nc" id="L141">                    poolHistory.getMargin(), poolHistory.getFixedCost(),</span>
<span class="nc" id="L142">                    delegator.getActiveStake() / adaInCirculation, relativePoolStake);</span>

<span class="nc" id="L144">        }</span>

<span class="nc" id="L146">        double poolOperatorReward = PoolRewardCalculation.calculateLeaderReward(totalPoolRewards,</span>
<span class="nc" id="L147">                poolHistory.getMargin(), poolHistory.getFixedCost(),</span>
                totalActiveStakeOfOwners / adaInCirculation, relativePoolStake);

<span class="nc" id="L150">        poolHistory.setPoolFees(poolOperatorReward - totalMemberRewardsOfOwners);</span>
<span class="nc" id="L151">        poolHistory.setDelegatorRewards(totalPoolRewards - poolOperatorReward + totalMemberRewardsOfOwners);</span>

<span class="nc" id="L153">        return poolHistory;</span>
    }

    @Override
    public Double getPoolPledgeInEpoch(String poolId, int epoch) {
<span class="nc" id="L158">        DbSyncPoolUpdate dbSyncPoolUpdate = dbSyncPoolUpdateRepository.findLastestUpdateForEpoch(poolId, epoch);</span>
<span class="nc" id="L159">        return dbSyncPoolUpdate.getPledge();</span>
    }

    @Override
    public PoolOwnerHistory getHistoryOfPoolOwnersInEpoch(String poolId, int epoch) {
<span class="nc" id="L164">        PoolOwnerHistory poolOwnerHistory = new PoolOwnerHistory();</span>
<span class="nc" id="L165">        poolOwnerHistory.setEpoch(epoch);</span>

<span class="nc" id="L167">        List&lt;PoolEpochStake&gt; poolEpochStakes = dbSyncEpochStakeRepository.getPoolActiveStakeInEpoch(poolId, epoch);</span>
<span class="nc" id="L168">        DbSyncPoolUpdate dbSyncPoolUpdate = dbSyncPoolUpdateRepository.findLastestUpdateForEpoch(poolId, epoch);</span>
<span class="nc" id="L169">        List&lt;DbSyncPoolOwner&gt; owners = dbSyncPoolOwnerRepository.getByPoolUpdateId(dbSyncPoolUpdate.getId());</span>

<span class="nc" id="L171">        List&lt;String&gt; stakeAddresses = owners.stream()</span>
<span class="nc" id="L172">                .map(DbSyncPoolOwner::getStakeAddress)</span>
<span class="nc" id="L173">                .map(DbSyncStakeAddress::getView)</span>
<span class="nc" id="L174">                .toList();</span>

<span class="nc" id="L176">        double activeStakes = 0.0;</span>

<span class="nc bnc" id="L178" title="All 2 branches missed.">        for (PoolEpochStake poolEpochStake : poolEpochStakes) {</span>
<span class="nc bnc" id="L179" title="All 2 branches missed.">            if (stakeAddresses.contains(poolEpochStake.getStakeAddress())) {</span>
<span class="nc" id="L180">                activeStakes += poolEpochStake.getAmount();</span>
            }
<span class="nc" id="L182">        }</span>
<span class="nc" id="L183">        poolOwnerHistory.setStakeAddresses(stakeAddresses);</span>
<span class="nc" id="L184">        poolOwnerHistory.setActiveStake(activeStakes);</span>
<span class="nc" id="L185">        return poolOwnerHistory;</span>
    }

    @Override
    public List&lt;PoolDeregistration&gt; getRetiredPoolsInEpoch(int epoch) {
<span class="nc" id="L190">        List&lt;DbSyncPoolRetirement&gt; dbSyncPoolRetirements = dbSyncPoolRetirementRepository.getPoolRetirementsByEpoch(epoch);</span>
<span class="nc" id="L191">        return dbSyncPoolRetirements.stream().map(PoolDeregistrationMapper::fromDbSyncPoolRetirement).toList();</span>
    }

    @Override
    public List&lt;AccountUpdate&gt; getAccountUpdatesUntilEpoch(List&lt;String&gt; stakeAddresses, int epoch) {
<span class="nc" id="L196">        List&lt;AccountUpdate&gt; accountUpdates = new ArrayList&lt;&gt;();</span>

<span class="nc" id="L198">        List&lt;DbSyncAccountDeregistration&gt; stakeDeregistrationsInEpoch =</span>
<span class="nc" id="L199">                dbSyncStakeDeregistrationRepository.getLatestAccountDeregistrationsUntilEpochForAddresses(stakeAddresses, epoch);</span>
<span class="nc" id="L200">        List&lt;DbSyncAccountRegistration&gt; stakeRegistrationsInEpoch =</span>
<span class="nc" id="L201">                dbSyncStakeRegistrationRepository.getLatestAccountRegistrationsUntilEpochForAddresses(stakeAddresses, epoch);</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">        for (DbSyncAccountDeregistration deregistration : stakeDeregistrationsInEpoch) {</span>
<span class="nc" id="L204">            accountUpdates.add(AccountUpdate.builder()</span>
<span class="nc" id="L205">                    .epoch(deregistration.getEpoch())</span>
<span class="nc" id="L206">                    .action(AccountUpdateAction.DEREGISTRATION)</span>
<span class="nc" id="L207">                    .stakeAddress(deregistration.getAddress().getView())</span>
<span class="nc" id="L208">                    .unixBlockTime(deregistration.getTransaction().getBlock().getTime().getTime())</span>
<span class="nc" id="L209">                    .build());</span>
<span class="nc" id="L210">        }</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">        for (DbSyncAccountRegistration registration : stakeRegistrationsInEpoch) {</span>
<span class="nc" id="L213">            accountUpdates.add(AccountUpdate.builder()</span>
<span class="nc" id="L214">                    .epoch(registration.getEpoch())</span>
<span class="nc" id="L215">                    .action(AccountUpdateAction.REGISTRATION)</span>
<span class="nc" id="L216">                    .stakeAddress(registration.getAddress().getView())</span>
<span class="nc" id="L217">                    .unixBlockTime(registration.getTransaction().getBlock().getTime().getTime())</span>
<span class="nc" id="L218">                    .build());</span>
<span class="nc" id="L219">        }</span>

<span class="nc" id="L221">        return  accountUpdates;</span>
    }

    @Override
    public List&lt;MirCertificate&gt; getMirCertificatesInEpoch(final int epoch) {
<span class="nc" id="L226">        List&lt;DbSyncReward&gt; mirCertificatesInEpoch = dbSyncRewardRepository.getMIRCertificatesInEpoch(epoch);</span>
<span class="nc" id="L227">        List&lt;MirCertificate&gt; mirCertificates = new ArrayList&lt;&gt;();</span>

<span class="nc bnc" id="L229" title="All 2 branches missed.">        for (DbSyncReward dbSyncReward : mirCertificatesInEpoch) {</span>
<span class="nc" id="L230">            MirCertificate mirCertificate = new MirCertificate();</span>
<span class="nc" id="L231">            mirCertificate.setPot(MirPot.valueOf(dbSyncReward.getType().toUpperCase()));</span>
<span class="nc" id="L232">            mirCertificate.setTotalRewards(dbSyncReward.getAmount());</span>
<span class="nc" id="L233">            mirCertificates.add(mirCertificate);</span>
<span class="nc" id="L234">        }</span>

<span class="nc" id="L236">        return mirCertificates;</span>
    }

    @Override
    public int getPoolRegistrationsInEpoch(int epoch) {
<span class="nc" id="L241">        return dbSyncPoolUpdateRepository.countPoolRegistrationsInEpoch(epoch);</span>
    }

    @Override
    public List&lt;PoolUpdate&gt; getPoolUpdateAfterTransactionIdInEpoch(String poolId, long transactionId, int epoch) {
<span class="nc" id="L246">        return dbSyncPoolUpdateRepository.findByBech32PoolIdAfterTransactionIdInEpoch(poolId, transactionId, epoch).stream()</span>
<span class="nc" id="L247">                .map(PoolUpdateMapper::fromDbSyncPoolUpdate).toList();</span>
    }

    @Override
    public PoolDeregistration latestPoolRetirementUntilEpoch(String poolId, int epoch) {
<span class="nc" id="L252">        DbSyncPoolRetirement dbSyncPoolRetirement = dbSyncPoolRetirementRepository.latestPoolRetirementUntilEpoch(poolId, epoch);</span>
<span class="nc" id="L253">        return PoolDeregistrationMapper.fromDbSyncPoolRetirement(dbSyncPoolRetirement);</span>
    }

    @Override
    public Double getTransactionDepositsInEpoch(int epoch) {
<span class="nc" id="L258">        return dbSyncTransactionRepository.getSumOfDepositsInEpoch(epoch);</span>
    }

    @Override
    public Double getSumOfFeesInEpoch(int epoch) {
<span class="nc" id="L263">        return dbSyncTransactionRepository.getSumOfFeesInEpoch(epoch);</span>
    }

    @Override
    public Double getSumOfWithdrawalsInEpoch(int epoch) {
<span class="nc" id="L268">        return dbSyncWithdrawalRepository.getSumOfWithdrawalsInEpoch(epoch);</span>
    }

    public List&lt;String&gt; getPoolsThatProducedBlocksInEpoch(int epoch) {
<span class="nc" id="L272">        return dbSyncBlockRepository.getPoolsThatProducedBlocksInEpoch(epoch);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>