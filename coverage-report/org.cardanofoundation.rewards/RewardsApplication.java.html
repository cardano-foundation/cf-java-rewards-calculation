<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RewardsApplication.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">cf-rewards-validation</a> &gt; <a href="index.source.html" class="el_package">org.cardanofoundation.rewards</a> &gt; <span class="el_source">RewardsApplication.java</span></div><h1>RewardsApplication.java</h1><pre class="source lang-java linenums">package org.cardanofoundation.rewards;

import org.cardanofoundation.rewards.validation.data.fetcher.DbSyncDataFetcher;
import org.cardanofoundation.rewards.validation.data.fetcher.KoiosDataFetcher;
import org.cardanofoundation.rewards.validation.data.plotter.JsonDataPlotter;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.boot.ApplicationArguments;
import org.springframework.boot.ApplicationRunner;
import org.springframework.boot.ExitCodeGenerator;
import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;
import org.springframework.boot.autoconfigure.domain.EntityScan;
import org.springframework.boot.context.properties.EnableConfigurationProperties;
import org.springframework.context.ApplicationContext;

@EnableConfigurationProperties
@EntityScan({&quot;org.cardanofoundation.rewards.*&quot;, &quot;org.cardanofoundation.*&quot;})
@SpringBootApplication
<span class="fc" id="L22">public class RewardsApplication implements ApplicationRunner {</span>
<span class="fc" id="L23">  private static final Logger logger = LoggerFactory.getLogger(RewardsApplication.class);</span>

  @Value(&quot;${application.run.mode}&quot;)
  private String runMode;

  @Value(&quot;${application.fetch.override}&quot;)
  private boolean overrideFetchedData;

  @Value(&quot;${spring.profiles.active:Unknown}&quot;)
  private String activeProfiles;

  @Value(&quot;${json.data-fetcher.start-epoch}&quot;)
  private int dataFetcherStartEpoch;

  @Value(&quot;${json.data-fetcher.end-epoch}&quot;)
  private int dataFetcherEndEpoch;

  @Value(&quot;${json.data-fetcher.skip-validation-data}&quot;)
  private boolean skipValidationData;

  @Autowired
  private ApplicationContext context;

  @Autowired
  private JsonDataPlotter jsonDataPlotter;

  @Autowired
  private KoiosDataFetcher koiosDataFetcher;

  @Autowired(required = false)
  private DbSyncDataFetcher dbSyncDataFetcher;

  public static void main(String[] args) {
<span class="nc" id="L56">    SpringApplication.run(RewardsApplication.class, args);</span>
<span class="nc" id="L57">  }</span>

  @Override
  public void run(ApplicationArguments args) throws Exception {

<span class="pc bpc" id="L62" title="1 of 2 branches missed.">      if (runMode == null) {</span>
<span class="nc" id="L63">        logger.warn(&quot;No run mode specified. Set the environment variable RUN_MODE in your .env file to 'fetch' or 'plot' or 'test'&quot;);</span>
<span class="nc" id="L64">        int exitCode = SpringApplication.exit(context, (ExitCodeGenerator) () -&gt; 0);</span>
<span class="nc" id="L65">        System.exit(exitCode);</span>
      }

<span class="fc" id="L68">      int startEpoch = dataFetcherStartEpoch;</span>
<span class="fc" id="L69">      int endEpoch = dataFetcherEndEpoch;</span>

<span class="pc bpc" id="L71" title="1 of 2 branches missed.">      if (runMode.equals(&quot;fetch&quot;)) {</span>
<span class="nc" id="L72">          boolean override = overrideFetchedData;</span>
<span class="nc" id="L73">          logger.info(&quot;Override fetched data: &quot; + override);</span>

<span class="nc bnc" id="L75" title="All 2 branches missed.">          if (activeProfiles.contains(&quot;db-sync&quot;)) {</span>
<span class="nc" id="L76">            logger.info(&quot;DB Sync data provider is active. Fetching data from DB Sync...&quot;);</span>

<span class="nc bnc" id="L78" title="All 2 branches missed.">            for (int epoch = startEpoch; epoch &lt; endEpoch; epoch++) {</span>
<span class="nc" id="L79">              logger.info(&quot;Fetching data for epoch with the DB sync data provider &quot; + epoch);</span>
<span class="nc" id="L80">              dbSyncDataFetcher.fetch(epoch, override, skipValidationData);</span>
            }
          }

<span class="nc bnc" id="L84" title="All 2 branches missed.">          if (activeProfiles.contains(&quot;koios&quot;)) {</span>
<span class="nc" id="L85">            logger.info(&quot;Koios data provider is active. Fetching data from Koios...&quot;);</span>
<span class="nc bnc" id="L86" title="All 2 branches missed.">            for (int epoch = startEpoch; epoch &lt; endEpoch; epoch++) {</span>
<span class="nc" id="L87">                logger.info(&quot;Fetching data for epoch with the Koios data provider &quot; + epoch);</span>
<span class="nc" id="L88">                koiosDataFetcher.fetch(epoch, override, skipValidationData);</span>
            }
          }
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">      } else if (runMode.equals(&quot;plot&quot;)) {</span>
<span class="nc" id="L92">        jsonDataPlotter.plot(startEpoch, endEpoch);</span>
<span class="pc bpc" id="L93" title="1 of 2 branches missed.">      } else if (!runMode.equals(&quot;test&quot;)) {</span>
<span class="nc" id="L94">          logger.warn(&quot;Unknown run mode: &quot; + runMode);</span>
      }

<span class="pc bpc" id="L97" title="1 of 2 branches missed.">      if (!runMode.equals(&quot;test&quot;)) {</span>
<span class="nc" id="L98">          logger.info(&quot;Done. Exiting...&quot;);</span>
<span class="nc" id="L99">          int exitCode = SpringApplication.exit(context, () -&gt; 0);</span>
<span class="nc" id="L100">          System.exit(exitCode);</span>
      }
<span class="fc" id="L102">  }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>