# Cardano Rewards Calculation

<p align="left">
<img alt="Tests" src="https://github.com/cardano-foundation/cf-java-rewards-calculation/actions/workflows/tests.yaml/badge.svg?branch=main" />
<img alt="Coverage" src="https://github.com/cardano-foundation/cf-java-rewards-calculation/blob/gh-pages/badges/jacoco.svg?raw=true" />
<img alt="Release" src="https://github.com/cardano-foundation/cf-java-rewards-calculation/actions/workflows/release.yaml/badge.svg?branch=main" />
<a href="https://conventionalcommits.org"><img alt="conventionalcommits" src="https://img.shields.io/badge/Conventional%20Commits-1.0.0-%23FE5196?logo=conventionalcommits" /></a>
<a href="https://opensource.org/licenses/MIT"><img alt="License" src="https://img.shields.io/badge/License-MIT-green.svg" /></a>
</p>

This project is aims to target *multiple goals*. First of all, it tries to *re-implement the cardano ledger rules* for calculating 
the [ADA pots](https://cexplorer.io/pot) (Treasury, Reserves, Rewards, Deposits, Utxo, Fees), as well as the rewards for stake pool operators and delegators. 
The second goal is to use this implementation to *[validate the rewards calculation](https://cardano-foundation.github.io/cf-java-rewards-calculation/report-latest/treasury_calculation.html)* of the Cardano blockchain by providing a *different implementation of the [ledger specification](https://github.com/IntersectMBO/cardano-ledger?tab=readme-ov-file#cardano-ledger)*.
The third goal is to *provide a library* that can be used in other project (such as [yaci-store](https://github.com/bloxbean/yaci-store)) to serve the rewards data *independently of [DB Sync](https://github.com/IntersectMBO/cardano-db-sync)*. 
Last but not least, this project could also be used to *understand the influence of protocol parameters* and the flow of ADA through an interactive report.

üößÔ∏è The calculation is currently correct until the beginning of the Babbage era. üößÔ∏è

## üß™ Test Reports

To ensure the stability and reliability of this project, unit tests have been implemented. By clicking on the link below, you can access the detailed test report.
We also generate for each version of this project calculation reports. These reports are generated by the unit tests and contain the calculation results compared to the actual values.

üìà [Treasury Calculation Report](https://cardano-foundation.github.io/cf-java-rewards-calculation/report-latest/treasury_calculation.html)
üìä [Coverage Report](https://cardano-foundation.github.io/cf-java-rewards-calculation/coverage-report/)

```mermaid
flowchart
    A[Total Transaction Fees <br />at Epoch n] --> B[Total Reward Pot <br />at Epoch n]
    B --> | <b><i>treasuryGrowthRate</b></i> | C[Treasury]
    B --> | 1 - <b><i>treasuryGrowthRate</b></i> | D[Stake Pool Rewards Pot <br />at Epoch n]
        subgraph ADA_POTS[" "]
        D --> | Unclaimed Rewards | E["ADA Reserves<br /> (monetary expansion) <br /> Started at ~14B ADA"]
        E --> | <b><i>monetaryExpandRate</a></b></i> * Performance of all Stake Pools | B
        C --> F[Payouts e.g. for <br />Project Catalyst]
        D --> | Rewards Equation<br /> for Pool 1 | G[Stake Pool 1]
        D --> | ewards Equation<br /> for Pool 2 | H[Stake Pool 2]
        D --> I[...]
        D --> | Rewards Equation<br /> for Pool n | J[Stake Pool n]
        J --> | <b><i>margin & minPoolCost</i></b> | K[Operators]
        J --> | <b><i>rewards</i></b> | L[Delegators]
        D --> | Rewards going to<br /> de-registered<br /> stake addresses | C
        L <--> | Stake Key Registration & <br /> Deregistration | M[Deposits]
        K <--> | Stake Pool Registration & <br /> Deregistration | M
        M --> | Unclaimed Refunds for Retired Pools | C
        end

    style A fill:#5C8DFF,stroke:#5C8DFF
    style B fill:#5C8DFF,stroke:#5C8DFF
    style C fill:#1EC198,stroke:#1EC198
    style D fill:#5C8DFF,stroke:#5C8DFF
    style E fill:#1EC198,stroke:#1EC198

    style F fill:#F6C667,stroke:#F6C667
    style G fill:#F6C667,stroke:#F6C667
    style H fill:#F6C667,stroke:#F6C667
    style I fill:#F6C667,stroke:#F6C667
    style J fill:#F6C667,stroke:#F6C667

    style ADA_POTS fill:#f6f9ff,stroke:#f6f9ff
```

## üöÄ Getting Started

#### Prerequisites

Java 17

#### Build & Test

```
git clone https://github.com/cardano-foundation/cf-java-rewards-calculation.git
cd cf-java-rewards-calculation
./mvnw clean test
```
#### Data Provider
The pool rewards calculation and also the treasury calculation requires a data provider to perform the calculation.
This repository offers different data providers and also an interface if you want to add your own provider. The following data providers are available:

 - [Koios Data Provider](./src/main/java/org/cardanofoundation/rewards/validation/data/provider/KoiosDataProvider.java)
 - [JSON Data Provider](./src/main/java/org/cardanofoundation/rewards/validation/data/provider/JsonDataProvider.java)
 - [DbSync Data Provider](./src/main/java/org/cardanofoundation/rewards/validation/data/provider/DbSyncDataProvider.java)

#### Data Fetcher

The data fetcher is used to fetch the data from the data provider and put it into local json files.
These files can be used to perform the calculation using the JSON Data Provider. The following data fetchers are available:

 - [Koios Data Fetcher](./src/main/java/org/cardanofoundation/rewards/validation/data/fetcher/KoiosDataFetcher.java)
 - [DbSync Data Fetcher](./src/main/java/org/cardanofoundation/rewards/validation/data/fetcher/DbSyncDataFetcher.java)

To make the application fetching the data, create an .env file with the following content in the `src/main/resources` folder:

```
SPRING_PROFILES_ACTIVE=db-sync

RUN_MODE=fetch
OVERWRITE_EXISTING_DATA=false

POSTGRES_USER=<username>
POSTGRES_PASSWORD=<password>
POSTGRES_DB=cexplorer

JSON_DATA_SOURCE_FOLDER=/path/to/your/rewards-calculation-test-data
```
`‚ö†Ô∏è The actual rewards data will also be fetched but only used from the validator and not within the calculation package.`
  
## ü´° Roadmap
 - [ ] Create REST endpoints to get the rewards as a service
 - [X] Include MIR certificates
 - [ ] Add a `/docs` folder containing parsable Markdown files to explain MIR certificates and edge cases
 - [ ] Enhance reporting and add values for the other pots as well. Include information from the `/docs` folder
 - [X] Calculate member and operator rewards
 - [X] Add deposits and utxo pot
 - [X] Calculate unclaimed rewards that need to go back to the reserves
 - [X] Put rewards to unregistered stake addresses into the treasury
 - [ ] Create a web ui to visualize the rewards calculation
 - [ ] Find out the root cause of the difference between the actual rewards and the calculated rewards beginning with epoch 350

## üìñ Sources
 - [Shelley Cardano Delegation Specification](https://github.com/input-output-hk/cardano-ledger/releases/download/cardano-ledger-spec-2023-04-03/shelley-ledger.pdf)
 - [Shelley Cardano Ledger Specification](https://github.com/input-output-hk/cardano-ledger/releases/download/cardano-ledger-spec-2023-04-03/shelley-ledger.pdf)
 - [Protocol Parameters - CIP-0009](https://cips.cardano.org/cips/cip9/#updatableprotocolparameters)
 - Beavr Cardano Stake Pool: [How is the Rewards Pot (R) Calculated](https://archive.ph/HQfoV/fb8166e31d2bf61d3d6ca769e7785f2a96530f8e.webp)
 - [History of Protocol Parameters](https://beta.explorer.cardano.org/en/protocol-parameters/)
